{{- range .Values.bootstrap -}}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ .name }}
  namespace: {{ default "argocd" $.Values.argocdNamespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "10"
spec:
  destination:
    namespace: {{ .name }}
    server: https://kubernetes.default.svc
  project: default
  source:
    helm:
      valueFiles:
        - values.yaml
    path: {{ .name }} 
    repoURL: {{ $.Values.repository }}
    targetRevision: HEAD
  syncPolicy:
      automated:
        prune: true
        selfHeal: true        
      syncOptions:
        - ApplyOutOfSyncOnly=true
        # - CreateNamespace=true
        # - Replace=true
---        
apiVersion: v1
kind: Namespace
metadata:
  name: {{ .name }}
  labels:
    {{- if .monitoring }}
    monitoring: "enabled"
    {{- end }}
{{- if .monitoring -}}
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: servicemonitor-{{ .name }}    
  namespace: prometheus
spec:
  endpoints:
    - interval: 30s
      port: metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - {{ .name }}
  selector:
    matchLabels:
      monitoring: enabled
{{- end -}}    

{{ end }}